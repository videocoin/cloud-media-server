<!doctype html>
<html>
<head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
    <title>WebRTC Demo</title>
</head>

<body>
    <h1>WebRTC Demo</h1>

    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <div id="status">...</div>
	<div id="conference">
		<div id="container"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script type='text/javascript'>
        let container;
        let HOST = "https://studio.snb.videocoin.network";
        let TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoxLCJleHAiOjE2MDY5MjUzMzcsInN1YiI6IjI2ZGQxZTA5LTMxNTEtNGQ0ZC03NzRmLWNkMDUwM2RmOTA2NyJ9.mpSF9f5rtaIqmQpTV7lsDeHkRUjpo4UNbw_mLOgNqro";
        let HEADERS = {"Authorization": "Bearer " + TOKEN}

        var pc = new RTCPeerConnection({
            sdpSemantics :'plan-b'
        });

        var videoStream, vs;
            
        pc.onaddstream = function(event) {
            console.log(event);
            addVideoForStream(event.stream);
        };
            
        pc.onremovestream = function(event) {
            console.log(event);
            removeVideoForStream(event.stream);
        };

        function addVideoForStream(stream, muted) {
            const video = document.createElement("video");
            video.id = stream.id;
            video.width = 320;
            video.height = 240;
            video.srcObject = stream;
            video.autoplay = true;
            video.muted = muted;
            container.appendChild(video);
            videoStream = stream;
        }
    
        function removeVideoForStream(stream) {
            stream.getTracks().forEach(function(track) {
                track.stop();
            });
            var video = document.getElementById(stream.id);
            video.remove();
            pc.removeStream(stream);
            pc.close();
            pc = new RTCPeerConnection({
                sdpSemantics :'plan-b'
            });
        }
    
        function start() {
            container = document.getElementById('container');
            $("#status").text("Creating...");

            $.ajax({
                type: "POST",
                url: HOST + "/api/v1/streams",
                data: JSON.stringify({"name": "webrtc-test-" + Date.now(), "profile_id": "190b9d72-208d-4fa2-90b7-5b203c0025d2"}),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                headers: {
                    "Authorization": "Bearer " + TOKEN,
                },
                success: function(resp) {
                    let streamId = resp.id;
                    $("#status").text("Running...");

                    $.ajax({
                        type: "POST",
                        url: HOST + "/api/v1/streams/" + streamId + "/run",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        headers: HEADERS,
                        success: function(resp) {
                            console.log(resp);

                            $("#status").text("Waiting...");

                            let timerId = setInterval(function() {
                                $.ajax({
                                    type: "GET",
                                    url: HOST + "/api/v1/streams/" + streamId,
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    headers: HEADERS,
                                    success: function(resp) {
                                        $("#status").text("Waiting... (status is " + resp.status + ")");
                                        if (resp.status == 'STREAM_STATUS_PREPARED') {
                                            clearInterval(timerId);

                                            vs = navigator.mediaDevices.getUserMedia({
                                                audio: true,
                                                video: true
                                            }).then(function(stream) {
                                                console.log("stream: ", stream);
                                    
                                                addVideoForStream(stream, true);
                                                pc.addStream(stream);
                                    
                                                const offer = pc.createOffer({
                                                    offerToReceiveAudio: true,
                                                    offerToReceiveVideo: true
                                                }).then(function(offer) {
                                                    console.log("offer: ", offer);
                                                    console.log("sdp: \n", offer.sdp);

                                                    pc.setLocalDescription(offer);

                                                    $.ajax({
                                                        type: "POST",
                                                        url: HOST + "/api/v1/ms/streams/webrtc",
                                                        data: JSON.stringify({"stream_id": resp.id, "sdp": offer.sdp}),
                                                        contentType: "application/json; charset=utf-8",
                                                        dataType: "json",
                                                        headers: HEADERS,
                                                        success: function(resp) {
                                                            console.log("answer\n", resp.sdp);
                                                            const answer = new RTCSessionDescription({
                                                                type: 'answer',
                                                                sdp: resp.sdp
                                                            });
                                                            pc.setRemoteDescription(answer).then(function(data) {
                                                                console.log(data);
                                                            }); 
                                                        },
                                                    });

                                                });
                                    
                                            });

                                        } else if (resp.status == 'STREAM_STATUS_FAILED') {
                                            $("#status").text("Unable to run stream");
                                            clearInterval(timerId);
                                        }
                                    }
                                })
                            }, 2000)
                        },
                        error: function(err) {
                            $("#status").text("Failed to run stream");
                            console.log(err);
                        }
                    })
                },
                error: function(err) {
                    $("#status").text("Failed to create stream");
                    console.log(err);
                }
            });
        }

        function stop() {
            removeVideoForStream(videoStream);
        }
    </script>
</body>

</html>